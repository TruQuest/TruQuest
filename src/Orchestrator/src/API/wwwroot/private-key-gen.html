<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>TruQuest</title>

    <script
      src="https://cdn.jsdelivr.net/npm/secrets.js-grempe@2.0.0/secrets.min.js"
      type="application/javascript"
    ></script>

    <script
      src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"
      type="application/javascript"
    ></script>

    <script>
      window.addEventListener("message", async function (e) {
        if (e.origin != "http://localhost:53433") return;

        var message = e.data;
        var messageSplit = message.split("|");
        var requestId = messageSplit[0];
        var command = messageSplit[1];

        if (command == "gen") {
          //   var wallet = ethers.Wallet.createRandom();
          // @@TODO: Different files for dev and prod.
          var wallet = ethers.Wallet.fromMnemonic(
            "atom traffic guard castle father vendor modify sauce rebuild true mixture van",
            "m/44'/60'/0'/0/1"
          );
          var keyShares = secrets.share(wallet.privateKey.substring(2), 2, 2);
          var confirmationCode = messageSplit[2];
          var signatureOverCode = await wallet.signMessage(confirmationCode);
          wallet = null;

          localStorage.setItem("keyShare", keyShares[1]);

          e.source.postMessage(
            `view-private-key-gen|${requestId}|${keyShares[0]}|${signatureOverCode}`,
            "http://localhost:53433"
          );
          keyShares = null;
        } else if (command == "sign-digest") {
          var serverKeyShare = messageSplit[2];
          var digest = messageSplit[3];
          var localKeyShare = localStorage.getItem("keyShare");

          var privateKey =
            "0x" + secrets.combine([serverKeyShare, localKeyShare]);
          serverKeyShare = null;
          localKeyShare = null;

          var signingKey = new ethers.utils.SigningKey(privateKey);
          privateKey = null;

          // @@NOTE: MUST arrayify first, because otherwise 'hashMessage' will UTF-8-encode the digest.
          var hashedEthereumPrefixedMessage = ethers.utils.hashMessage(
            ethers.utils.arrayify(digest)
          );
          var signature = signingKey.signDigest(hashedEthereumPrefixedMessage);
          signingKey = null;

          var serializedSignature =
            "0x" +
            signature.r.substring(2) +
            signature.s.substring(2) +
            (signature.v == 27 ? "1b" : "1c");

          e.source.postMessage(
            `view-private-key-gen|${requestId}|${serializedSignature}`,
            "http://localhost:53433"
          );
        }
      });
    </script>
  </head>
  <body></body>
</html>
